// Copyright 2025 The Oppia Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS-IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Unit tests to operate the playback of autogenerated audio
 * using the SpeechSynthesis API.
 */

import {async, TestBed} from '@angular/core/testing';
import {AutomaticVoiceoverHighlightService} from './automatic-voiceover-highlight-service';

describe('Automatic voiceover highlight service', () => {
  let automaticVoiceoverHighlightService: AutomaticVoiceoverHighlightService;

  beforeEach(async(() => {
    TestBed.configureTestingModule({});
    automaticVoiceoverHighlightService = TestBed.inject(
      AutomaticVoiceoverHighlightService
    );
  }));

  it('should set active content id', () => {
    automaticVoiceoverHighlightService.setActiveContentId('content_id');
    expect(automaticVoiceoverHighlightService.activeContentId).toBe(
      'content_id'
    );
  });

  it('should set automated voiceovers audio offsets', () => {
    let contentIdToVoiceoversAudioOffsetsMsecs = {
      content0: [
        {token: 'This', audioOffsetMsecs: 0.0},
        {token: 'is', audioOffsetMsecs: 100.0},
        {token: 'from', audioOffsetMsecs: 200.0},
        {token: 'cached', audioOffsetMsecs: 300.0},
        {token: 'model', audioOffsetMsecs: 400.0},
      ],
    };

    automaticVoiceoverHighlightService.setAutomatedVoiceoversAudioOffsets(
      contentIdToVoiceoversAudioOffsetsMsecs
    );
    expect(
      automaticVoiceoverHighlightService.automatedVoiceoversAudioOffsetsMsecs
    ).toEqual(contentIdToVoiceoversAudioOffsetsMsecs);
  });

  it('should be able to highlight ID to sentence map', () => {
    let highlightIdToSentenceMap = {
      highlightId1: 'This is first card!',
      highlightId2: 'Congratulations! You have completed the lesson.',
    };

    let highlightIdToSentenceWithoutSpacesMap = {
      highlightId1: 'Thisisfirstcard!',
      highlightId2: 'Congratulations!Youhavecompletedthelesson.',
    };

    expect(automaticVoiceoverHighlightService.highlightIdToSentenceMap).toEqual(
      {}
    );
    expect(
      automaticVoiceoverHighlightService.highlightIdToSentenceWithoutSpacesMap
    ).toEqual({});

    automaticVoiceoverHighlightService.languageCode = 'en';
    automaticVoiceoverHighlightService.setHighlightIdToSenetenceMap(
      highlightIdToSentenceMap
    );

    expect(automaticVoiceoverHighlightService.highlightIdToSentenceMap).toEqual(
      highlightIdToSentenceMap
    );
    expect(
      automaticVoiceoverHighlightService.highlightIdToSentenceWithoutSpacesMap
    ).toEqual(highlightIdToSentenceWithoutSpacesMap);
  });

  it('should get sentence to highlight interval list', () => {
    let automatedVoiceoversAudioOffsetsMsecs = {
      content0: [
        {token: 'Nic', audioOffsetMsecs: 0.0},
        {token: 'took', audioOffsetMsecs: 100.0},
        {token: 'Jaime', audioOffsetMsecs: 200.0},
        {token: 'to', audioOffsetMsecs: 300.0},
        {token: 'the', audioOffsetMsecs: 400.0},
        {token: 'arcade', audioOffsetMsecs: 500.0},
        {token: 'to', audioOffsetMsecs: 600.0},
        {token: 'take', audioOffsetMsecs: 700.0},
        {token: 'part', audioOffsetMsecs: 800.0},
        {token: 'in', audioOffsetMsecs: 900.0},
        {token: 'the', audioOffsetMsecs: 1000.0},
        {token: 'arcade’s', audioOffsetMsecs: 1100.0},
        {token: 'annual', audioOffsetMsecs: 1200.0},
        {token: 'game', audioOffsetMsecs: 1300.0},
        {token: 'competition', audioOffsetMsecs: 1400.0},
        {token: '.', audioOffsetMsecs: 1500.0},
        {token: 'The', audioOffsetMsecs: 1600.0},
        {token: 'winner', audioOffsetMsecs: 1700.0},
        {token: 'would', audioOffsetMsecs: 1800.0},
        {token: 'be', audioOffsetMsecs: 1900.0},
        {token: 'able', audioOffsetMsecs: 2000.0},
        {token: 'to', audioOffsetMsecs: 2100.0},
        {token: 'exchange', audioOffsetMsecs: 2200.0},
        {token: 'their', audioOffsetMsecs: 2300.0},
        {token: 'points', audioOffsetMsecs: 2400.0},
        {token: 'for', audioOffsetMsecs: 2500.0},
        {token: 'a', audioOffsetMsecs: 2600.0},
        {token: 'grand', audioOffsetMsecs: 2700.0},
        {token: 'prize', audioOffsetMsecs: 2800.0},
        {token: 'to', audioOffsetMsecs: 2900.0},
        {token: 'take', audioOffsetMsecs: 3000.0},
        {token: 'home', audioOffsetMsecs: 3100.0},
        {token: '!', audioOffsetMsecs: 3200.0},
      ],
    };

    let highlightIdToSentenceMap = {
      highlightId1:
        'Nic took Jaime to the arcade to take part in the arcade’s annual game competition.',
      highlightId2:
        'The winner would be able to exchange their points for a grand prize to take home!',
    };
    automaticVoiceoverHighlightService.languageCode = 'en';
    automaticVoiceoverHighlightService.setAutomatedVoiceoversAudioOffsets(
      automatedVoiceoversAudioOffsetsMsecs
    );
    automaticVoiceoverHighlightService.setHighlightIdToSenetenceMap(
      highlightIdToSentenceMap
    );
    automaticVoiceoverHighlightService.setActiveContentId('content0');

    automaticVoiceoverHighlightService.getSentencesToHighlightForTimeRanges();

    let exptectedSentenceHighlightIntervalList = [
      {
        highlightSentenceId: 'highlightId1',
        startTimeInSecs: 0,
        endTimeInSecs: 2,
      },
      {
        highlightSentenceId: 'highlightId2',
        startTimeInSecs: 2,
        endTimeInSecs: 3,
      },
    ];

    expect(
      automaticVoiceoverHighlightService.sentenceHighlightIntervalList
    ).toEqual(exptectedSentenceHighlightIntervalList);
  });

  it('should get highlight sentence ID from given audio time interval', () => {
    let sentenceHighlightIntervalList = [
      {
        highlightSentenceId: 'highlightId1',
        startTimeInSecs: 0,
        endTimeInSecs: 2,
      },
      {
        highlightSentenceId: 'highlightId2',
        startTimeInSecs: 2,
        endTimeInSecs: 5,
      },
      {
        highlightSentenceId: 'highlightId3',
        startTimeInSecs: 6,
        endTimeInSecs: 7,
      },
    ];

    automaticVoiceoverHighlightService.sentenceHighlightIntervalList =
      sentenceHighlightIntervalList;

    expect(
      automaticVoiceoverHighlightService.getCurrentSentenceIdToHighlight(2)
    ).toBe('highlightId1');
    expect(
      automaticVoiceoverHighlightService.getCurrentSentenceIdToHighlight(3)
    ).toBe('highlightId2');
    expect(
      automaticVoiceoverHighlightService.getCurrentSentenceIdToHighlight(6)
    ).toBe('highlightId3');
  });

  it('should pronounce correctly for superscripts', () => {
    // Mock AppConstants for math symbol pronunciations.
    const mathSymbolPronunciations = {
      '^2': 'squared',
      '^3': 'cubed',
      '^': 'to the power of',
    };

    let content = 'x^2 + y^2 = z^3';
    let expected = 'x squared + y squared = z cubed';
    expect(
      automaticVoiceoverHighlightService.processSuperscriptInText(
        content,
        mathSymbolPronunciations
      )
    ).toBe(expected);

    content = 'x² + 5 = z⁴';
    expected = 'x squared + 5 = z to the power of 4';
    expect(
      automaticVoiceoverHighlightService.processSuperscriptInText(
        content,
        mathSymbolPronunciations
      )
    ).toBe(expected);

    content = 'x + 5  = 10';
    expected = 'x + 5  = 10';
    expect(
      automaticVoiceoverHighlightService.processSuperscriptInText(
        content,
        mathSymbolPronunciations
      )
    ).toBe(expected);
  });

  it('should transform algebraic fractions correctly', () => {
    let content = 'Calculate x: x/4 = 2.';
    let expected = 'Calculate x: x / 4 = 2.';
    expect(
      automaticVoiceoverHighlightService.processAlgebraicFraction(content)
    ).toBe(expected);

    content = 'Calculate x: 4/x = 2.';
    expected = 'Calculate x: 4 / x = 2.';
    expect(
      automaticVoiceoverHighlightService.processAlgebraicFraction(content)
    ).toBe(expected);

    content = 'y/2 + 3/x = 5.';
    expected = 'y / 2 + 3 / x = 5.';
    expect(
      automaticVoiceoverHighlightService.processAlgebraicFraction(content)
    ).toBe(expected);

    content = 'No fractions here.';
    expected = 'No fractions here.';
    expect(
      automaticVoiceoverHighlightService.processAlgebraicFraction(content)
    ).toBe(expected);
  });

  it('should pronounce correctly for factorials', () => {
    const mathSymbolPronunciations = {
      '!': 'factorial of',
    };

    let content = '5! = 120';
    let expected = 'factorial of 5 = 120';
    expect(
      automaticVoiceoverHighlightService.processFactorialInText(
        content,
        mathSymbolPronunciations
      )
    ).toBe(expected);

    content = '3! + 4! = 30';
    expected = 'factorial of 3 + factorial of 4 = 30';
    expect(
      automaticVoiceoverHighlightService.processFactorialInText(
        content,
        mathSymbolPronunciations
      )
    ).toBe(expected);
  });

  describe('transformMathSentenceContainingAudioSpecficWords', () => {
    beforeEach(() => {
      automaticVoiceoverHighlightService.languageCode = 'en';
    });

    it('should transform math sentence with minus, plus, times, divided by, equals', () => {
      const sentence = '3 - 2 + 1 * 5 / 2 ÷ 2 = x';
      const expected =
        '3 minus 2 plus 1 times 5 divided by 2 divided by 2 equals x';
      expect(
        automaticVoiceoverHighlightService.transformMathSentenceContainingAudioSpecficWords(
          sentence
        )
      ).toBe(expected);
    });

    it('should transform math sentence with multiplication symbols', () => {
      const sentence = '2 × 3 * 4';
      const expected = '2 times 3 times 4';
      expect(
        automaticVoiceoverHighlightService.transformMathSentenceContainingAudioSpecficWords(
          sentence
        )
      ).toBe(expected);
    });

    it('should transform math sentence with multiple math symbols and dashes', () => {
      const sentence = 'a__b = g';
      const expected = 'a dash b equals g';
      expect(
        automaticVoiceoverHighlightService.transformMathSentenceContainingAudioSpecficWords(
          sentence
        )
      ).toBe(expected);
    });

    it('should not change sentence without math symbols', () => {
      const sentence = 'This is a simple sentence.';
      expect(
        automaticVoiceoverHighlightService.transformMathSentenceContainingAudioSpecficWords(
          sentence
        )
      ).toBe(sentence);
    });

    it('should use default language for pronunciation if language code is missing in constants', () => {
      const sentence = 'x^2 + y^2 = z^3';
      const expected = 'x squared plus y squared equals z cubed';
      automaticVoiceoverHighlightService.languageCode = 'fr';
      expect(
        automaticVoiceoverHighlightService.transformMathSentenceContainingAudioSpecficWords(
          sentence
        )
      ).toBe(expected);
    });
  });
});
